name: Test ARM64 Build (Linux only)

on:
  workflow_dispatch

jobs:
  build_test_arm64:
    name: Build and test ARM64 wheel on Linux
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]  # Test with a subset of Python versions

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install setuptools wheel cython build

      # Set up QEMU for ARM64 emulation
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      # Build ARM64 wheel using cibuildwheel
      - name: Build ARM64 manylinux wheels
        uses: pypa/cibuildwheel@v2.23.2
        env:
          CIBW_BUILD: cp${{ matrix.python-version == '3.10' && '310' || matrix.python-version == '3.11' && '311' || '312' }}-*
          CIBW_ARCHS_LINUX: "aarch64"
          CIBW_BUILD_VERBOSITY: 1

      # Store the built wheels
      - name: Store built ARM64 wheels
        uses: actions/upload-artifact@v4
        with:
          name: arm64-wheels-py${{ matrix.python-version }}
          path: wheelhouse/*.whl

      # List what was built
      - name: List built wheels
        run: |
          echo "Built wheels:"
          ls -lh wheelhouse/

  # Test the ARM64 wheels in an ARM64 environment
  test_arm64_wheel:
    needs: build_test_arm64
    name: Test ARM64 wheel (Python ${{ matrix.python-version }})
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      # Set up QEMU for ARM64 emulation
      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: arm64

      # Download the built wheel
      - name: Download ARM64 wheel
        uses: actions/download-artifact@v4
        with:
          name: arm64-wheels-py${{ matrix.python-version }}
          path: dist

      # Test in ARM64 container
      - name: Test wheel in ARM64 container
        run: |
          docker run --rm --platform linux/arm64 \
            -v $PWD:/workspace \
            -w /workspace \
            python:${{ matrix.python-version }}-slim \
            bash -c "
              pip install --upgrade pip && \
              pip install dist/*.whl && \
              python -c 'import xpress9; print(\"xpress9 imported successfully\")' && \
              if [ -f e2e_test.py ]; then python e2e_test.py; fi
            "

      - name: Test results
        run: echo "ARM64 wheel test completed successfully!"